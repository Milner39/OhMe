<script>
    // #region Imports

    // Import svgs
    import LogIn from "$lib/assets/svgs/LogIn.svelte"
    import Checkmark from "$lib/assets/svgs/Checkmark.svelte"

    // Import components
    import Banner from "$lib/components/Banner.svelte"
    import AutoScroll from "$lib/components/AutoScroll.svelte"

    /*
        https://kit.svelte.dev/docs/modules#$app-stores-page
        Store containing page information
    */
    import { page } from "$app/stores"

    /*
        `enhance`:
            https://kit.svelte.dev/docs/form-actions#progressive-enhancement-use-enhance
            Form action to improve the default behaviour of form elements.

        `applyAction`:
            https://kit.svelte.dev/docs/modules#$app-forms-applyaction
            Subroutine to update the `$page.form` property even if form 
            action is on another route.
    */
    import { enhance, applyAction } from "$app/forms"

    /*
        https://kit.svelte.dev/docs/modules#$app-navigation-goto
        Subroutine to redirect client
    */
    import { goto } from "$app/navigation"
    // #endregion



    /*
        Reactive statements are indicated by the `$:` label
        https://svelte.dev/docs/svelte-components#script-3-$-marks-a-statement-as-reactive
        "Reactive statements run:
         - after other script code
         - before the component markup is rendered
         - whenever the values that they depend on have changed."
    */

    /*
        https://kit.svelte.dev/docs/load#$page-data
        Get data from load subroutines
    */
    $: data = $page.data


    /*
        https://kit.svelte.dev/docs/form-actions#anatomy-of-an-action
        Get data from form actions
    */
    $: form = $page.form

    /*
        https://kit.svelte.dev/docs/state-management#storing-state-in-the-url
        Get data from URL
    */
    $: url = $page.url


    /*
        If `data`, `form`, or `url` change:
            - Check if a successful form was submitted.

            - Check if the form was one of the valid options
              to redirect from.

            - Check if the `redirectTo` search parameter
              is set.

            - Redirect client to the route set as `redirectTo`.
    */
    $: if (
        form?.status === 200 && 
        ["login", "register"].includes(data.mode) &&
        url.searchParams.get("redirectTo")
    ) {
        goto(`/${url.searchParams.get("redirectTo").slice(1)}`)
    }

</script>

<Banner>
    <LogIn slot="svg"/>
    <h4>Login</h4>
    <AutoScroll>
        <h6>Log in or register an account.</h6>
    </AutoScroll>
</Banner>

<div class="page">
    <div class="widthCtrl">
        <div class="block" class:success={data.user && form} class:returned={data.user && !form}>
            {#if data.user}
                {#if form}
                    <Checkmark/>
                    <h4 class="thickFW">Success</h4>
                    <h6>You have logged into your account. You can continue using the app as normal now.</h6>
                    <a class="button-pill" href="/">
                        <h6>Home</h6>
                    </a>
                {:else}
                    <h4 class="thickFW">Logout?</h4>
                    <h6>You are already logged into your account. You can logout here or continue to use the app as normal.</h6>
                    <form method="POST" action="/logout" 
                        use:enhance={() => {
                            return async ({ result, update }) => {
                                await applyAction(result)
                                await update()
                            }
                        }}
                    >
                        <button class="button-pill" type="submit"><h6>Log Out</h6></button>
                    </form>
                {/if}
            {:else}
                <h4 class="thickFW">
                    {
                    data.mode === "login" ? "Login" :
                    data.mode === "register" ? "Register" :
                    "Reset Password"
                    }
                </h4>
                {#if data.mode === "login"}
                    <h6>Enter your existing account details below.</h6>
                    <form class="form" method="POST" action="?/login" use:enhance>
                        <div>
                            <label for="email"><small>Email Address*</small></label>
                            <input type="text" name="email" id="email" required autocomplete="email"
                                class:invalid={form?.errors?.email}
                                placeholder={form?.errors?.email}
                            >
                        </div>
                        <div>
                            <label for="password"><small>Password*</small></label>
                            <input type="password" name="password" id="password" required autocomplete="current-password"
                                class:invalid={form?.errors?.password}
                                placeholder={form?.errors?.password}
                            >
                        </div>
                        <button class="button-pill" type="submit"><h6>Log In</h6></button>
                    </form>
                    <a href="?mode=reset" class="button-pill button-alt">
                        <h6>Forgot password</h6>
                    </a>
                    <h6>Don't have an account yet?</h6>
                    <a href="?mode=register" class="button-slim">
                        <h6>Register</h6>
                    </a>
                {:else if data.mode === "register"}
                    <h6>Enter your new account details below.</h6>
                    <form class="form" method="POST" action="?/register" use:enhance>
                        <div>
                            <label for="username"><small>Username*</small></label>
                            <input type="text" name="username" id="username" required autocomplete="username"
                                class:invalid={form?.errors?.username}
                                placeholder={form?.errors?.username}
                            >
                        </div>
                        <div>
                            <label for="email"><small>Email Address*</small></label>
                            <input type="text" name="email" id="email" required autocomplete="email"
                                class:invalid={form?.errors?.email}
                                placeholder={form?.errors?.email}
                            >
                        </div>
                        <div>
                            <label for="password"><small>Password*</small></label>
                            <input type="password" name="password" id="password" required autocomplete="new-password"
                                class:invalid={form?.errors?.password}
                                placeholder={form?.errors?.password}
                            >
                        </div>
                        <button class="button-pill" type="submit"><h6>Register</h6></button>
                    </form>
                    <h6>Have an account already?</h6>
                    <a href="?mode=login" class="button-slim">
                        <h6>Login</h6>
                    </a>
                {:else if data.mode === "reset"}
                    <h6>Sent a password reset link via email.</h6>
                    <form class="form" method="POST" action="?/reset" use:enhance>
                        <div>
                            <label for="email"><small>Email Address*</small></label>
                            <input type="text" name="email" id="email" required autocomplete="email"
                                class:invalid={form?.errors?.email}
                                placeholder={form?.errors?.email}
                            >
                        </div>
                        <button class="button-pill" type="submit"><h6>Reset</h6></button>
                    </form>
                    <a href="?mode=login" class="button-pill button-alt">
                        <h6>Cancel</h6>
                    </a>
                {/if}
            {/if}
        </div>
    </div>
</div>

<style lang="scss">

    .page {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: row;
    }

    .block {
        flex-grow: 1;
        max-width: 500px;

        text-align: center;

        &.success {
            >a {
                width: 100%;
            }

            >:global(svg) {
                height: 5rem;
                color: var(--green);
            }
        }

        &.returned {
            >form>button {
                width: 100%;
            };
        }

        >.form {
            display: grid;
            grid-auto-flow: row;
            gap: 1rem;

            label {
                margin-left: 2px;
                color: var(--tx-4);
                font-weight: 300;
                display: flex;
                text-align: left;
            }
            input {
                width: 100%;
            }
        }

    }

</style>